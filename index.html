<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AmazonRush — Full Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  /* Basic Amazon-ish / modern layout + dark mode */
  :root{
    --accent:#ff9900;
    --bg:#f3f4f6;
    --card:#fff;
    --text:#111;
  }
  .dark {
    --accent:#ffb84d;
    --bg:#121212;
    --card:#1e1e1f;
    --text:#e7e7e7;
  }
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:18px;background:var(--bg);color:var(--text)}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .logo{font-weight:800;font-size:20px;color:var(--accent)}
  .btn{background:var(--accent);color:#000;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
  .muted{color:rgba(0,0,0,0.55);font-size:13px}
  .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin:12px 0}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  img{width:100%;height:160px;object-fit:cover;border-radius:8px}
  input,select,textarea{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;box-sizing:border-box;margin:6px 0}
  .small{font-size:13px;color:rgba(0,0,0,0.6)}
  .row{display:flex;gap:8px;align-items:center}
  .hidden{display:none}
  .admin-badge{background:#222;color:#fff;padding:6px;border-radius:6px;font-weight:700}
  .switch{cursor:pointer;padding:6px;border-radius:6px;border:1px solid #ccc}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} .products{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))} }
</style>
</head>
<body>

<header>
  <div class="logo">amazonrush.com</div>
  <div class="row">
    <div id="balanceDisplay" class="small">Balance: $0.00</div>
    <button class="btn" onclick="showSection('catalog')">Store</button>
    <button class="btn" onclick="showSection('profile')">Profile</button>
    <button class="btn" onclick="showSection('support')">Support</button>
    <button class="btn" onclick="showAdminLogin()">Admin</button>
    <div style="margin-left:8px">
      <span class="switch" onclick="toggleDark()" id="darkToggle">Dark</span>
    </div>
  </div>
</header>

<div class="grid">

  <!-- Main column -->
  <div>

    <!-- Home / Auth -->
    <div id="homeCard" class="card">
      <h2>Welcome to AmazonRush</h2>
      <p class="small">Sign up, verify OTP, deposit and explore products. Admin can approve deposits, reviews, and withdrawals.</p>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="showSignUp()">User Sign Up</button>
        <button class="btn" onclick="showLogin()">User Login</button>
      </div>
    </div>

    <!-- Signup -->
    <div id="signupCard" class="card hidden">
      <h3>Sign up</h3>
      <input id="su_name" placeholder="Full name">
      <input id="su_phone" placeholder="Phone (digits only)">
      <input id="su_email" placeholder="Email">
      <input id="su_password" placeholder="Password" type="password">
      <div class="row">
        <button class="btn" onclick="startSignup()">Get OTP</button>
        <button class="btn" onclick="cancelAuth()">Cancel</button>
      </div>
      <div id="otpHint" class="small muted"></div>
    </div>

    <!-- OTP -->
    <div id="otpCard" class="card hidden">
      <h3>Enter OTP</h3>
      <input id="otp_input" placeholder="OTP">
      <div class="row">
        <button class="btn" onclick="verifyOtp()">Verify</button>
        <button class="btn" onclick="cancelAuth()">Cancel</button>
      </div>
      <div id="otpShown" class="small muted"></div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card hidden">
      <h3>User Login</h3>
      <input id="li_email" placeholder="Email">
      <input id="li_password" placeholder="Password" type="password">
      <div class="row">
        <button class="btn" onclick="loginUser()">Login</button>
        <button class="btn" onclick="cancelAuth()">Cancel</button>
      </div>
    </div>

    <!-- Catalog / Products -->
    <div id="catalog" class="card">
      <h3>Products</h3>
      <div class="products" id="productGrid"></div>
    </div>

    <!-- Product modal (simple) -->
    <div id="productModal" class="card hidden">
      <h3 id="pm_title"></h3>
      <img id="pm_img" alt="">
      <p class="small">Price: $<span id="pm_price"></span></p>
      <p class="small">Description: <span id="pm_desc"></span></p>
      <div class="row">
        <button class="btn" onclick="buyProduct()">Buy Now</button>
        <button class="btn" onclick="closeProduct()" style="background:#ccc">Close</button>
      </div>
      <div id="pm_notice" class="small muted"></div>
    </div>

    <!-- Profile / Deposit / Withdraw / Reviews / Purchase history -->
    <div id="profile" class="card hidden">
      <h3>Profile</h3>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div><strong id="p_name">—</strong></div>
          <div class="small" id="p_email">—</div>
        </div>
        <div class="small" id="p_location">Location: unknown</div>
      </div>

      <h4>Account</h4>
      <div class="row">
        <div>
          <div class="small">Account type: <strong id="p_account">Basic</strong></div>
          <button class="btn" onclick="upgradeToGolden()">Upgrade to Golden</button>
        </div>
        <div>
          <div class="small">OTP verified: <span id="p_verified">No</span></div>
          <button class="btn" onclick="requestOtp()" style="background:#8bc34a">Get OTP</button>
        </div>
      </div>

      <h4>Deposit</h4>
      <input id="deposit_amount" placeholder="Amount to deposit">
      <select id="deposit_method"><option>Bank - Palmpay</option><option>Crypto - Wallet</option></select>
      <div class="small">Bank name: Palmpay — Account: <strong>9052130055</strong></div>
      <div class="row">
        <button class="btn" onclick="submitDeposit()">Submit Deposit</button>
        <button class="btn" onclick="showDeposits()">My Deposits</button>
      </div>

      <h4>Withdraw</h4>
      <input id="withdraw_amount" placeholder="Amount to withdraw">
      <input id="withdraw_account" placeholder="Bank acc / wallet address">
      <div class="row">
        <button class="btn" onclick="requestWithdrawal()">Request Withdraw</button>
        <button class="btn" onclick="showWithdrawals()">My Withdrawals</button>
      </div>
      <div id="withdrawNotice" class="small muted"></div>

      <h4>Write Review (earn $20)</h4>
      <select id="review_product"></select>
      <textarea id="review_text" rows="3" placeholder="Write your review"></textarea>
      <div class="row">
        <button class="btn" onclick="submitReview()">Submit Review</button>
      </div>

      <h4>Purchase History</h4>
      <div id="purchaseHistory" class="small"></div>

      <h4>My Reviews</h4>
      <div id="myReviews" class="small"></div>

      <h4>Edit Profile</h4>
      <input id="edit_name" placeholder="Name">
      <input id="edit_phone" placeholder="Phone">
      <input id="edit_password" placeholder="Password" type="password">
      <div class="row">
        <button class="btn" onclick="saveProfile()">Save Profile</button>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Support Chat -->
    <div id="support" class="card hidden">
      <h3>Support</h3>
      <div id="chatWindow" style="height:200px;overflow:auto;border:1px solid #eee;padding:8px;background:#fafafa"></div>
      <input id="chatInput" placeholder="Ask a question">
      <div class="row">
        <button class="btn" onclick="sendChat()">Send</button>
        <button class="btn" onclick="clearChat()" style="background:#ccc">Clear</button>
      </div>
      <div class="small muted">Support replies in ~10 seconds (simulated).</div>
    </div>
  </div>

  <!-- Admin column -->
  <div>
    <div id="adminLogin" class="card">
      <h3>Admin</h3>
      <input id="admin_user" placeholder="Admin username">
      <input id="admin_pass" placeholder="Admin password" type="password">
      <div class="row">
        <button class="btn" onclick="adminLogin()">Login</button>
        <button class="btn" onclick="adminLogout()" style="background:#ccc">Logout</button>
      </div>
      <div class="small">Default admin user: <code>admin</code> password: <code>admin123</code></div>
    </div>

    <div id="adminPanel" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Admin Panel</h3>
        <div class="admin-badge">ADMIN</div>
      </div>

      <h4>Search</h4>
      <input id="admin_search" placeholder="Search users, reviews, tx" oninput="renderAdmin()">

      <h4>Users</h4>
      <div id="adminUsers" style="max-height:200px;overflow:auto"></div>

      <h4>Pending Deposits</h4>
      <div id="adminDeposits" style="max-height:140px;overflow:auto"></div>

      <h4>Pending Withdrawals</h4>
      <div id="adminWithdraws" style="max-height:140px;overflow:auto"></div>

      <h4>Pending Reviews</h4>
      <div id="adminReviews" style="max-height:140px;overflow:auto"></div>

      <h4>Transactions</h4>
      <div id="adminTx" style="max-height:180px;overflow:auto"></div>

      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="resetAll()">Reset All Data</button>
      </div>
    </div>
  </div>
</div>

<script>
/* -----------------------
   Data structures saved in localStorage:
   - ar_users: { email: {name, email, phone, password, balance, purchases:[], reviews:[], deposits:[], withdraws:[], verifiedOtp, golden, location, ua} }
   - ar_products: [ {id,title,price,img,desc} ]
   - ar_pendingDeposits: []
   - ar_pendingWithdraws: []
   - ar_pendingReviews: []
   - ar_transactions: []
   ------------------------ */

const LS = {
  USERS: 'ar_users_v2',
  PRODUCTS: 'ar_products_v2',
  PENDING_DEPOSITS: 'ar_pendingDeposits_v2',
  PENDING_WITHDRAWS: 'ar_pendingWithdraws_v2',
  PENDING_REVIEWS: 'ar_pendingReviews_v2',
  TRANSACTIONS: 'ar_transactions_v2'
};

let currentEmail = null;
let currentOtp = null;
let lastViewedProduct = null;

/* ---------- Utilities ---------- */
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, fallback){ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
function uid(prefix='id'){ return prefix + Date.now().toString(36) + Math.floor(Math.random()*999).toString(36); }
function formatMoney(v){ return parseFloat(v).toFixed(2); }
function now(){ return new Date().toISOString(); }

/* ---------- Initialize sample products (prices 500 - 30000) ---------- */
function ensureProducts(){
  if(localStorage.getItem(LS.PRODUCTS)) return;
  const sample = [
    {id:'prod1',title:'Pro Wireless Earbuds',price: randPrice(500,30000),img:'https://picsum.photos/seed/ear/400/300',desc:'Wireless earbuds with noise cancellation.'},
    {id:'prod2',title:'Smart Watch X',price: randPrice(500,30000),img:'https://picsum.photos/seed/watch/400/300',desc:'Health tracking smartwatch.'},
    {id:'prod3',title:'Portable Speaker Pro',price: randPrice(500,30000),img:'https://picsum.photos/seed/speak/400/300',desc:'Loud Bluetooth speaker.'},
    {id:'prod4',title:'Power Bank 30000mAh',price: randPrice(500,30000),img:'https://picsum.photos/seed/charg/400/300',desc:'High-capacity charger.'},
    {id:'prod5',title:'Gaming Headset',price: randPrice(500,30000),img:'https://picsum.photos/seed/game/400/300',desc:'Surround sound gaming headset.'}
  ];
  save(LS.PRODUCTS, sample);
}
function randPrice(min,max){ return Math.round((Math.random()*(max-min))+min); }

/* ---------- Users helpers ---------- */
function getUsers(){ return load(LS.USERS, {}); }
function saveUsers(u){ save(LS.USERS, u); }
function getProducts(){ return load(LS.PRODUCTS, []); }
function getPendingDeposits(){ return load(LS.PENDING_DEPOSITS, []); }
function savePendingDeposits(a){ save(LS.PENDING_DEPOSITS, a); }
function getPendingWithdraws(){ return load(LS.PENDING_WITHDRAWS, []); }
function savePendingWithdraws(a){ save(LS.PENDING_WITHDRAWS, a); }
function getPendingReviews(){ return load(LS.PENDING_REVIEWS, []); }
function savePendingReviews(a){ save(LS.PENDING_REVIEWS, a); }
function getTx(){ return load(LS.TRANSACTIONS, []); }
function saveTx(a){ save(LS.TRANSACTIONS, a); }

/* ---------- Boot ---------- */
ensureProducts();
renderProducts();
renderAdmin();

/* ---------- UI show/hide ---------- */
function showSection(id){
  ['homeCard','signupCard','otpCard','loginCard','catalog','productModal','profile','support'].forEach(x=>{
    document.getElementById(x).classList.add('hidden');
  });
  document.getElementById(id).classList.remove('hidden');
}
function showSignUp(){ showSection('signupCard'); }
function showLogin(){ showSection('loginCard'); }
function cancelAuth(){ showSection('homeCard'); }

/* ---------- Signup / OTP ---------- */
function startSignup(){
  const name = document.getElementById('su_name').value.trim();
  const phone = document.getElementById('su_phone').value.trim();
  const email = document.getElementById('su_email').value.trim().toLowerCase();
  const pass = document.getElementById('su_password').value;
  if(!name||!phone||!email||!pass){ alert('Fill all fields'); return; }
  const users = getUsers();
  if(users[email]){ alert('Email already used. Please login.'); return; }
  // create user skeleton but not fully verified
  users[email] = { name, phone, email, password:pass, balance:0, purchases:[], reviews:[], deposits:[], withdraws:[], verifiedOtp:false, golden:false, location:null, ua: navigator.userAgent, created: now() };
  saveUsers(users);
  // get OTP (simulated)
  currentOtp = Math.floor(100000 + Math.random()*900000).toString();
  currentEmail = email;
  document.getElementById('otpShown').innerText = 'OTP (simulated): ' + currentOtp;
  showSection('otpCard');
  // attempt to capture geolocation (optional)
  captureLocation(email);
}

function verifyOtp(){
  const entered = document.getElementById('otp_input').value.trim();
  if(!currentOtp || !currentEmail){ alert('No OTP in progress'); return; }
  if(entered !== currentOtp){ alert('Incorrect OTP'); return; }
  const users = getUsers();
  if(users[currentEmail]){ users[currentEmail].verifiedOtp = true; saveUsers(users); alert('OTP verified — you can now login.'); }
  currentOtp = null;
  showSection('homeCard');
}

function loginUser(){
  const email = document.getElementById('li_email').value.trim().toLowerCase();
  const pass = document.getElementById('li_password').value;
  const users = getUsers();
  if(!users[email] || users[email].password !== pass){ alert('Invalid credentials'); return; }
  currentEmail = email;
  // set UI
  showSection('catalog');
  renderProfile();
  updateBalanceDisplay();
  renderProducts();
}

/* ---------- Product rendering & modal ---------- */
function renderProducts(){
  const prods = getProducts();
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';
  prods.forEach(p=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `<img src="${p.img}" alt=""><h4>${p.title}</h4><div class="small">Price: $${formatMoney(p.price)}</div><div style="margin-top:8px"><button class="btn" onclick="openProduct('${p.id}')">View / Buy</button></div>`;
    grid.appendChild(card);
  });
  // for review product select
  const sel = document.getElementById('review_product'); sel.innerHTML = prods.map(pp=>`<option value="${pp.id}">${pp.title} — $${formatMoney(pp.price)}</option>`).join('');
}

function openProduct(id){
  const p = getProducts().find(x=>x.id===id);
  lastViewedProduct = p;
  document.getElementById('pm_title').innerText = p.title;
  document.getElementById('pm_img').src = p.img;
  document.getElementById('pm_price').innerText = formatMoney(p.price);
  document.getElementById('pm_desc').innerText = p.desc;
  document.getElementById('pm_notice').innerText = '';
  document.getElementById('productModal').classList.remove('hidden');
}
function closeProduct(){ document.getElementById('productModal').classList.add('hidden'); }

/* ---------- Purchase flow ---------- */
function buyProduct(){
  if(!currentEmail){ alert('Login required'); return; }
  const users = getUsers();
  const user = users[currentEmail];
  if(!user.verifiedOtp){ alert('You must verify OTP first to buy'); return; }

  const p = lastViewedProduct;
  if(!p){ alert('No product selected'); return; }
  // simulate purchase: add purchase record, adjust balances per rule
  // Add product price + 70% of price to user's balance
  const add1 = p.price;
  const add2 = Math.round(p.price * 0.7);
  user.purchases.push({id: uid('buy'), productId: p.id, title: p.title, price: p.price, date: now()});
  user.balance = (user.balance || 0) + add1 + add2;
  // save transaction log
  const tx = getTx();
  tx.unshift({id:uid('tx'), user:currentEmail, type:'Purchase', amount: p.price, extra: add2, date: now(), productId:p.id});
  saveTx(tx);
  users[currentEmail] = user;
  saveUsers(users);
  updateBalanceDisplay();
  renderProfile();
  renderProducts();
  document.getElementById('pm_notice').innerText = `Purchased. $${formatMoney(add1)} + $${formatMoney(add2)} (70%) credited.`;
  alert('Purchase success. Balance updated.');
}

/* ---------- Profile rendering, edit ---------- */
function renderProfile(){
  if(!currentEmail){ showSection('homeCard'); return; }
  const users = getUsers();
  const u = users[currentEmail];
  if(!u) return;
  showSection('profile');
  document.getElementById('p_name').innerText = u.name;
  document.getElementById('p_email').innerText = u.email;
  document.getElementById('p_account').innerText = u.golden ? 'Golden' : 'Basic';
  document.getElementById('p_verified').innerText = u.verifiedOtp ? 'Yes' : 'No';
  document.getElementById('edit_name').value = u.name;
  document.getElementById('edit_phone').value = u.phone;
  document.getElementById('edit_password').value = u.password;
  document.getElementById('purchaseHistory').innerHTML = u.purchases.map(p=>`<div class="small">• ${p.title} — $${formatMoney(p.price)} — ${new Date(p.date).toLocaleString()}</div>`).join('') || '<div class="small muted">No purchases</div>';
  document.getElementById('myReviews').innerHTML = u.reviews.map(r=>`<div class="small">• ${r.text} — <em>${r.status||'pending'}</em></div>`).join('') || '<div class="small muted">No reviews</div>';
  document.getElementById('p_location').innerText = 'Location: ' + (u.location ? `${u.location.lat.toFixed(3)},${u.location.lon.toFixed(3)}` : 'not shared');
  updateBalanceDisplay();
}

/* ---------- Save profile ---------- */
function saveProfile(){
  if(!currentEmail) return;
  const users = getUsers();
  const u = users[currentEmail];
  u.name = document.getElementById('edit_name').value.trim() || u.name;
  u.phone = document.getElementById('edit_phone').value.trim() || u.phone;
  const pwd = document.getElementById('edit_password').value;
  if(pwd) u.password = pwd;
  users[currentEmail] = u;
  saveUsers(users);
  alert('Profile saved');
  renderProfile();
}

/* ---------- Deposit flow ---------- */
function submitDeposit(){
  if(!currentEmail){ alert('Login required'); return; }
  const amt = parseFloat(document.getElementById('deposit_amount').value);
  const method = document.getElementById('deposit_method').value;
  if(!amt || amt <= 0){ alert('Enter valid amount'); return; }
  // require OTP verified
  const users = getUsers();
  const u = users[currentEmail];
  if(!u.verifiedOtp){ alert('Verify OTP before depositing'); return; }
  // create pending deposit for admin approval
  const pend = getPendingDeposits();
  const d = {id: uid('dep'), user: currentEmail, amount: amt, method, date: now(), status:'pending'};
  pend.unshift(d);
  savePendingDeposits(pend);
  alert('Deposit submitted and pending admin approval. Bank details: Palmpay 9052130055');
  document.getElementById('deposit_amount').value = '';
  renderAdmin();
}

/* ---------- Withdraw flow with rules ---------- */
/* Sequence:
   Rule 1: Must deposit $300 first (total deposited ever >=300)
   Rule 2: After Rule1, must upgrade to Golden account
   Rule 3: After Golden, must have >=3 purchases (count purchases)
   Rule 4: After >=3 purchases, must have purchased at least one product priced between 1000-10000
   Final: After all satisfied, any withdrawal attempt always declines with message about law.
*/
function requestWithdrawal(){
  if(!currentEmail){ alert('Login required'); return; }
  const amt = parseFloat(document.getElementById('withdraw_amount').value);
  const account = document.getElementById('withdraw_account').value.trim();
  if(!amt || amt<=0){ alert('Enter valid amount'); return; }
  const users = getUsers();
  const u = users[currentEmail];
  if(!u.verifiedOtp){ alert('Verify OTP before withdrawing'); return; }

  // compute total approved deposits (for simplicity consider both pending and approved recorded in user's deposits array)
  const totalDeposited = u.deposits ? u.deposits.reduce((s,x)=>s + (x.amount||0), 0) : 0;

  // Rule 1:
  if(totalDeposited < 300){
    document.getElementById('withdrawNotice').innerText = 'You must deposit $300 before making a withdrawal.';
    return;
  }

  // Rule 2: Golden account
  if(!u.golden){
    document.getElementById('withdrawNotice').innerText = 'You must upgrade your account to Golden before withdrawal.';
    return;
  }

  // Rule 3: at least 3 purchases
  const purchaseCount = (u.purchases || []).length;
  if(purchaseCount < 3){
    document.getElementById('withdrawNotice').innerText = 'You must purchase at least 3 products before withdrawal can continue.';
    return;
  }

  // Rule 4: at least one purchase between 1000 and 10000
  const hasRangePurchase = (u.purchases || []).some(p => p.price >= 1000 && p.price <= 10000);
  if(!hasRangePurchase){
    document.getElementById('withdrawNotice').innerText = 'You must purchase a product between $1,000 and $10,000 before withdrawal.';
    return;
  }

  // Final denial (always decline)
  document.getElementById('withdrawNotice').innerText = 'Withdrawal declined due to the high law in your country.';
  // record the attempt anyway
  const pend = getPendingWithdraws();
  pend.unshift({ id: uid('wd'), user: currentEmail, amount: amt, account, date: now(), status:'declined_by_policy' });
  savePendingWithdraws(pend);
  renderAdmin();
}

/* ---------- Review system ---------- */
function submitReview(){
  if(!currentEmail){ alert('Login required'); return; }
  const prodId = document.getElementById('review_product').value;
  const text = document.getElementById('review_text').value.trim();
  if(!text){ alert('Write a review'); return; }
  const users = getUsers();
  const u = users[currentEmail];
  if(!u.reviews) u.reviews = [];
  // create pending review
  const pend = getPendingReviews();
  const r = {id: uid('rev'), user: currentEmail, productId: prodId, text, date: now(), status:'pending' };
  pend.unshift(r);
  savePendingReviews(pend);
  // also attach to user's reviews as pending
  u.reviews.push({id: r.id, text, status:'pending', date: now()});
  users[currentEmail] = u;
  saveUsers(users);
  alert('Review submitted and pending admin approval. Once approved $20 bonus will be credited.');
  document.getElementById('review_text').value = '';
  renderAdmin();
}

/* ---------- Support chat (10s reply) ---------- */
function sendChat(){
  const text = document.getElementById('chatInput').value.trim();
  if(!text) return;
  const win = document.getElementById('chatWindow');
  const tdiv = document.createElement('div'); tdiv.innerHTML = `<div style="text-align:right"><strong>You:</strong> ${escapeHtml(text)}</div>`;
  win.appendChild(tdiv); win.scrollTop = win.scrollHeight;
  document.getElementById('chatInput').value = '';
  // simulate reply after 10 seconds
  setTimeout(()=>{ const r = document.createElement('div'); r.innerHTML = `<div style="text-align:left"><strong>Support:</strong> Thanks — we received your message and will review it. (auto)</div>`; win.appendChild(r); win.scrollTop = win.scrollHeight; }, 10000);
}
function clearChat(){ document.getElementById('chatWindow').innerHTML = ''; }

/* ---------- Admin: login, render, approve actions ---------- */
function showAdminLogin(){ document.getElementById('adminLogin').scrollIntoView(); }
function adminLogin(){
  const user = document.getElementById('admin_user').value.trim();
  const pass = document.getElementById('admin_pass').value;
  if(user === 'admin' && pass === 'admin123'){
    document.getElementById('adminPanel').classList.remove('hidden');
    document.getElementById('adminLogin').classList.add('hidden');
    renderAdmin();
  } else alert('Invalid admin credentials');
}
function adminLogout(){
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('adminLogin').classList.remove('hidden');
}

/* Render admin area */
function renderAdmin(){
  const search = document.getElementById('admin_search') ? document.getElementById('admin_search').value.toLowerCase() : '';
  const users = getUsers();
  const arr = Object.values(users);
  const filtered = search ? arr.filter(u=> (u.name||'').toLowerCase().includes(search) || (u.email||'').toLowerCase().includes(search) || (u.phone||'').includes(search) ) : arr;
  // users list
  const ul = document.getElementById('adminUsers'); ul.innerHTML = filtered.map(u=>{
    const totalDeposited = (u.deposits||[]).reduce((s,x)=>s + (x.amount||0),0);
    const purchases = (u.purchases||[]).length;
    const inStage = computeRestrictionStage(u);
    const loc = u.location ? `${u.location.lat.toFixed(3)},${u.location.lon.toFixed(3)}` : (u.location === null ? 'denied' : 'unknown');
    return `<div class="small" style="border-bottom:1px solid #eee;padding:6px">
      <strong>${escapeHtml(u.name)}</strong> — ${escapeHtml(u.email)}<br>
      Balance: $${formatMoney(u.balance||0)} | Deposited: $${formatMoney(totalDeposited)} | Purchases: ${purchases}<br>
      Location: ${loc} | UA: ${escapeHtml(u.ua||'')}<br>
      Stage: <strong>${inStage}</strong>
    </div>`;
  }).join('') || '<div class="small muted">No users</div>';
  // pending deposits
  const pd = getPendingDeposits();
  document.getElementById('adminDeposits').innerHTML = pd.map((d,i)=>`<div class="small" style="border-bottom:1px solid #eee;padding:6px">
    ${escapeHtml(d.user)} | $${formatMoney(d.amount)} | ${escapeHtml(d.method)} | ${new Date(d.date).toLocaleString()}
    <div class="row"><button class="btn" onclick="approveDeposit(${i})">Approve</button><button class="btn" onclick="rejectDeposit(${i})" style="background:#d9534f">Reject</button></div>
  </div>`).join('') || '<div class="small muted">No pending deposits</div>';
  // pending withdraws (we record attempts too)
  const pw = getPendingWithdraws();
  document.getElementById('adminWithdraws').innerHTML = pw.map((w,i)=>`<div class="small" style="border-bottom:1px solid #eee;padding:6px">
    ${escapeHtml(w.user)} | $${formatMoney(w.amount)} | ${escapeHtml(w.status||'pending')} | ${new Date(w.date).toLocaleString()}
  </div>`).join('') || '<div class="small muted">No withdraw attempts</div>';
  // pending reviews
  const pr = getPendingReviews();
  document.getElementById('adminReviews').innerHTML = pr.map((r,i)=>`<div class="small" style="border-bottom:1px solid #eee;padding:6px">
    ${escapeHtml(r.user)} | ${escapeHtml(r.text)} | ${new Date(r.date).toLocaleString()}
    <div class="row"><button class="btn" onclick="approveReview(${i})">Approve (+$20)</button><button class="btn" onclick="rejectReview(${i})" style="background:#d9534f">Reject</button></div>
  </div>`).join('') || '<div class="small muted">No pending reviews</div>';
  // transactions
  const tx = getTx();
  document.getElementById('adminTx').innerHTML = tx.map(t=>`<div class="small" style="border-bottom:1px solid #eee;padding:6px">${escapeHtml(t.user)} | ${escapeHtml(t.type)} | $${formatMoney(t.amount)} | ${new Date(t.date).toLocaleString()}</div>`).join('') || '<div class="small muted">No transactions</div>';
}

/* ---------- Admin actions ---------- */
function approveDeposit(index){
  const pend = getPendingDeposits();
  const d = pend.splice(index,1)[0];
  savePendingDeposits(pend);
  const users = getUsers();
  if(users[d.user]){
    users[d.user].deposits = users[d.user].deposits || [];
    users[d.user].deposits.push({id: uid('depA'), amount: d.amount, date: now()});
    users[d.user].balance = (users[d.user].balance || 0) + d.amount;
    saveUsers(users);
    // record tx
    const tx = getTx(); tx.unshift({id:uid('tx'), user:d.user, type:'Deposit', amount:d.amount, date:now()}); saveTx(tx);
  }
  renderAdmin(); renderProfile();
  alert('Deposit approved and balance credited.');
}
function rejectDeposit(index){
  const pend = getPendingDeposits(); pend.splice(index,1); savePendingDeposits(pend); renderAdmin(); alert('Deposit rejected.');
}

function approveReview(index){
  const pend = getPendingReviews();
  const r = pend.splice(index,1)[0];
  savePendingReviews(pend);
  const users = getUsers();
  if(users[r.user]){
    users[r.user].reviews = users[r.user].reviews || [];
    users[r.user].reviews = users[r.user].reviews.map(rv => rv.id === r.id ? {...rv, status:'approved'} : rv);
    // ensure review exists in user reviews (it was added when submitted)
    users[r.user].reviews.push({id: r.id, text: r.text, status:'approved', date: now()});
    // credit $20
    users[r.user].balance = (users[r.user].balance || 0) + 20;
    saveUsers(users);
    const tx = getTx(); tx.unshift({id:uid('tx'), user:r.user, type:'ReviewBonus', amount:20, date:now()}); saveTx(tx);
  }
  renderAdmin(); renderProfile();
  alert('Review approved and $20 credited.');
}
function rejectReview(index){
  const pend = getPendingReviews(); pend.splice(index,1); savePendingReviews(pend); renderAdmin(); alert('Review rejected.'); 
}

/* ---------- Withdraw admin utilities (we mainly record attempts) ---------- */

/* ---------- Compute restriction stage for admin display ---------- */
function computeRestrictionStage(u){
  const totalDeposited = (u.deposits||[]).reduce((s,x)=>s + (x.amount||0),0);
  if(totalDeposited < 300) return 'Rule 1: Deposit $300';
  if(!u.golden) return 'Rule 2: Upgrade to Golden';
  if((u.purchases||[]).length < 3) return 'Rule 3: Purchase 3 products';
  if(! ( (u.purchases||[]).some(p=> p.price >= 1000 && p.price <=10000) ) ) return 'Rule 4: Buy product $1,000–$10,000';
  return 'Final: Policy Deny';
}

/* ---------- Reset ---------- */
function resetAll(){ if(confirm('Delete all data?')){ localStorage.removeItem(LS.USERS); localStorage.removeItem(LS.PENDING_DEPOSITS); localStorage.removeItem(LS.PENDING_WITHDRAWS); localStorage.removeItem(LS.PENDING_REVIEWS); localStorage.removeItem(LS.TRANSACTIONS); ensureProducts(); renderProducts(); renderAdmin(); alert('Reset done'); } }

/* ---------- Simple helpers ---------- */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Purchases view & balance ---------- */
function updateBalanceDisplay(){
  const users = getUsers();
  const u = currentEmail ? users[currentEmail] : null;
  document.getElementById('balanceDisplay').innerText = 'Balance: $' + (u?formatMoney(u.balance||0):'0.00');
}

function showDeposits(){
  if(!currentEmail) return alert('Login required');
  const users = getUsers(); const u = users[currentEmail];
  alert('Your deposits (approved):\\n' + (u.deposits && u.deposits.length ? u.deposits.map(d=>`$${formatMoney(d.amount)} — ${new Date(d.date).toLocaleString()}`).join('\\n') : 'No deposits'));
}
function showWithdrawals(){
  if(!currentEmail) return alert('Login required');
  const users = getUsers(); const u = users[currentEmail];
  alert('Your withdraw attempts:\\n' + (u.withdraws && u.withdraws.length ? u.withdraws.map(w=>`$${formatMoney(w.amount)} — ${w.status||'pending'}`).join('\\n') : 'No withdraws'));
}

/* ---------- Upgrade to Golden ---------- */
function upgradeToGolden(){
  if(!currentEmail) return alert('Login required');
  const users = getUsers(); const u = users[currentEmail];
  // Choose a golden fee, e.g., $50 — you didn't specify price, so we'll ask user to confirm
  const fee = 50;
  if(confirm(`Upgrade to Golden for $${fee}? This will be deducted from your balance (simulated).`)){
    if((u.balance||0) < fee){ alert('Insufficient balance for upgrade. Please deposit or buy products.'); return; }
    u.balance -= fee; u.golden = true;
    users[currentEmail] = u; saveUsers(users);
    // Record tx
    const tx = getTx(); tx.unshift({id:uid('tx'), user:currentEmail, type:'UpgradeGolden', amount:fee, date:now()}); saveTx(tx);
    alert('Account upgraded to Golden.');
    renderProfile(); renderAdmin(); updateBalanceDisplay();
  }
}

/* ---------- Logout ---------- */
function logout(){ currentEmail = null; showSection('homeCard'); updateBalanceDisplay(); }

/* ---------- Admin wrappers for UI rendering ---------- */
function renderAdminWrapper(){ renderAdmin(); }

/* ---------- Capture geolocation for user (store lat/lon) ---------- */
function captureLocation(email){
  // attempt geolocation
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    const users = getUsers();
    if(users[email]){
      users[email].location = {lat: pos.coords.latitude, lon: pos.coords.longitude, accuracy: pos.coords.accuracy};
      users[email].ua = navigator.userAgent;
      saveUsers(users);
    }
  }, err=>{
    // store denied marker
    const users = getUsers();
    if(users[email]){
      users[email].location = null; // denied
      users[email].ua = navigator.userAgent;
      saveUsers(users);
    }
  }, {timeout:7000});
}

/* ---------- Admin approve helpers already defined above ---------- */

/* ---------- Helper to render products and admin on load ---------- */
function renderProducts(){ ensureProducts(); renderProductsUI(); }
function renderProductsUI(){
  const prods = getProducts();
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';
  prods.forEach(p=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `<img src="${p.img}" alt=""><h4>${escapeHtml(p.title)}</h4><div class="small">Price: $${formatMoney(p.price)}</div><div style="margin-top:8px"><button class="btn" onclick="openProduct('${p.id}')">View / Buy</button></div>`;
    grid.appendChild(card);
  });
  // fill review select
  const sel = document.getElementById('review_product'); if(sel){
    sel.innerHTML = prods.map(pp=>`<option value="${pp.id}">${pp.title} — $${formatMoney(pp.price)}</option>`).join('');
  }
}

/* ---------- Approve / reject reviews already included ---------- */

/* ---------- Utility: renderAdmin initial ---------- */
renderAdmin();

/* ---------- Dark mode toggle ---------- */
function toggleDark(){
  document.body.classList.toggle('dark');
  document.getElementById('darkToggle').innerText = document.body.classList.contains('dark') ? 'Light' : 'Dark';
}

/* ---------- Simple admin-facing functions export for inline onclicks ---------- */
window.approveDeposit = approveDeposit;
window.rejectDeposit = rejectDeposit;
window.approveReview = approveReview;
window.rejectReview = rejectReview;

/* ---------- End ---------- */
</script>
</body>
</html>